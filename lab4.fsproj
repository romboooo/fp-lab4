<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
  </PropertyGroup>

  <ItemGroup>
    <Compile Include="src/Database.fs" />
    <Compile Include="src/Schema.fs" />
    <Compile Include="src/SqlParser.fs" />
    <Compile Include="src/TypeGenerator.fs" />
    <Compile Include="generated/GeneratedTypes.fs">
      <Visible>false</Visible>
    </Compile>
    <Compile Include="Program.fs" />
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="dotenv.net" Version="4.0.0" />
    <PackageReference Include="Npgsql" Version="8.0.4" />
  </ItemGroup>

  <Target Name="EnsureGeneratedTypesExists" BeforeTargets="BeforeBuild">
    <Message Text="Checking for generated types file..." Importance="normal" />
    
    <PropertyGroup>
      <GeneratedTypesPath>generated/GeneratedTypes.fs</GeneratedTypesPath>
    </PropertyGroup>
    
    <MakeDir Directories="generated" Condition="!Exists('generated')" />
    
    <WriteLinesToFile
      File="$(GeneratedTypesPath)"
      Lines="namespace ORM.GeneratedTypes%0A%0Aopen System%0A%0A// This file will be auto-generated%0A// Run: dotnet run -- --generate-types"
      Overwrite="false"
      Condition="!Exists('$(GeneratedTypesPath)')" />
    
    <Message Text="Generated types file exists or was created: $(GeneratedTypesPath)" 
             Importance="normal" 
             Condition="Exists('$(GeneratedTypesPath)')" />
  </Target>

  <Target Name="RegenerateTypes">
    <Message Text="Forcing type regeneration..." Importance="high" />
    <Exec Command="dotnet run -- --generate-types" 
          WorkingDirectory="$(MSBuildProjectDirectory)"
          IgnoreExitCode="false" />
  </Target>

  <Target Name="CleanGeneratedTypes" AfterTargets="Clean">
    <Delete Files="generated/GeneratedTypes.fs" Condition="Exists('generated/GeneratedTypes.fs')" />
    <Message Text="Cleaned generated types file" Importance="high" />
  </Target>
</Project>